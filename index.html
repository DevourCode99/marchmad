<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meal Maker App</title>
  <style>
    /* Basic reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Arial", sans-serif;
      background: #f5f5f5;
      color: #333;
    }

    /* Container styling */
    .app-container {
      max-width: 700px;
      margin: 40px auto;
      background: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Headings */
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    h2 {
      margin-bottom: 10px;
      color: #2c3e50;
    }

    /* Main menu buttons */
    .menu-btn {
      display: inline-block;
      margin: 5px;
      padding: 12px 16px;
      border: none;
      border-radius: 4px;
      background-color: #2980b9;
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
    }
    .menu-btn:hover {
      background-color: #1b6a8f;
    }

    /* Back button */
    .back-btn {
      margin-bottom: 20px;
      padding: 10px 16px;
      border: none;
      border-radius: 4px;
      background-color: #bdc3c7;
      color: #444;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .back-btn:hover {
      background-color: #a8b1b3;
    }

    /* Sections */
    .hidden {
      display: none;
    }

    /* Grocery and Recipe lists */
    #grocery-list-container, #recipe-container {
      margin-top: 10px;
      line-height: 1.6;
    }

    /* Sub-lists for grocery items */
    .grocery-category {
      margin-top: 15px;
    }
    .grocery-category h3 {
      color: #2c3e50;
      margin-bottom: 5px;
    }
    .grocery-category ul {
      margin-left: 20px;
      list-style: disc;
    }

    .today-date {
      font-size: 1.2rem;
      color: #555;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <h1>Meal Maker App</h1>
    <div id="main-menu" class="menu-section">
      <h2>Main Menu</h2>
      <div id="today-date-container" class="today-date">
        <!-- The JavaScript will insert today's date here. -->
      </div>
      <button id="btnGroceryList" class="menu-btn">Grocery List</button>
      <button id="btnRecipeToday" class="menu-btn">Recipe for Today</button>
    </div>

    <!-- GROCERY LIST SECTION -->
    <div id="grocery-section" class="hidden">
      <button class="back-btn">&larr; Back</button>
      <h2>Grocery List</h2>
      <div id="grocery-list-container">
        <!-- The JavaScript will insert grocery list data here. -->
      </div>
    </div>

    <!-- RECIPE SECTION -->
    <div id="recipe-section" class="hidden">
      <button class="back-btn">&larr; Back</button>
      <h2>Today's Recipe</h2>
      <div id="recipe-container">
        <!-- The JavaScript will insert recipe details here. -->
      </div>
    </div>
  </div>

  <script>
    /**
     * Meal Maker App script
     *
     * This script:
     * 1. Determines today's date in CST (YYYY-MM-DD).
     * 2. Fetches pull.json to find the groupNumber, recipeNumber, and groceryDay for today's date.
     * 3. Displays today's date, allows user to see the grocery list for the current group, or the recipe if recipeNumber is available.
     * 4. Pulls the correct grocery list from grocery_list.json by matching groupNumber.
     * 5. Pulls the correct recipe from rec{groupNumber}.json by matching recipeNumber.
     */

    // HTML element references
    const mainMenu = document.getElementById("main-menu");
    const grocerySection = document.getElementById("grocery-section");
    const recipeSection = document.getElementById("recipe-section");

    const todayDateContainer = document.getElementById("today-date-container");
    const groceryListContainer = document.getElementById("grocery-list-container");
    const recipeContainer = document.getElementById("recipe-container");

    const btnGroceryList = document.getElementById("btnGroceryList");
    const btnRecipeToday = document.getElementById("btnRecipeToday");

    const backButtons = document.querySelectorAll(".back-btn");

    // Global variables (determined on load)
    let currentGroupNumber = null;
    let currentRecipeNumber = null;
    let isGroceryDay = false;

    /**
     * Get today's date in YYYY-MM-DD format, in Central Standard Time (CST).
     */
    function getTodayDateCST() {
      const now = new Date();
      // Convert local time to CST by using toLocaleString with America/Chicago
      const cstString = now.toLocaleString("en-US", { timeZone: "America/Chicago" });
      const cstDate = new Date(cstString);

      // Format as YYYY-MM-DD
      const year = cstDate.getFullYear();
      const month = String(cstDate.getMonth() + 1).padStart(2, "0");
      const day = String(cstDate.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    /**
     * Show or hide sections
     */
    function showSection(sectionToShow) {
      // Hide all sections
      [mainMenu, grocerySection, recipeSection].forEach(sec => {
        sec.classList.add("hidden");
      });
      // Show the requested section
      sectionToShow.classList.remove("hidden");
    }

    /**
     * Load the grocery list for the current group number from grocery_list.json.
     */
    async function loadGroceryList() {
      try {
        const response = await fetch("data/grocery_list.json");
        const data = await response.json();

        if (!data.groceryLists) return;

        // Find the matching groupNumber object
        const groupData = data.groceryLists.find(
          (g) => g.groupNumber === currentGroupNumber
        );

        if (!groupData) {
          groceryListContainer.innerHTML = "<p>No grocery list found for this group.</p>";
          return;
        }

        // Build the display
        let html = `<p>Grocery list for <strong>Group ${currentGroupNumber}</strong>${
          isGroceryDay ? " (It's your grocery day!)" : ""
        }</p>`;

        // Each category
        html += createGroceryCategoryHTML("Produce", groupData.produce);
        html += createGroceryCategoryHTML("Meat/Poultry", groupData.meatPoultry);
        html += createGroceryCategoryHTML("Canned/Packaged/Dry Goods", groupData.cannedPackagedDryGoods);

        groceryListContainer.innerHTML = html;
      } catch (error) {
        console.error("Error loading grocery list:", error);
        groceryListContainer.innerHTML =
          "<p>Error loading grocery list. Check console for details.</p>";
      }
    }

    /**
     * Helper to create grocery category HTML
     */
    function createGroceryCategoryHTML(title, items) {
      if (!items || !Array.isArray(items)) return "";
      let html = `
        <div class="grocery-category">
          <h3>${title}</h3>
          <ul>
            ${items.map((item) => `<li>${item}</li>`).join("")}
          </ul>
        </div>`;
      return html;
    }

    /**
     * Load the recipe for today from the appropriate rec{groupNumber}.json.
     */
    async function loadRecipe() {
      try {
        if (!currentRecipeNumber) {
          recipeContainer.innerHTML = "<p>No recipe scheduled for today.</p>";
          return;
        }

        // Fetch the file for the current group
        const fileName = `data/rec${currentGroupNumber}.json`;
        const response = await fetch(fileName);
        const data = await response.json();

        if (!data.recipes) {
          recipeContainer.innerHTML =
            "<p>No recipes found in the data for this group.</p>";
          return;
        }

        // Find the recipe by recipeNumber
        const recipeData = data.recipes.find(
          (r) => r.recipeNumber === currentRecipeNumber
        );

        if (!recipeData) {
          recipeContainer.innerHTML =
            "<p>Recipe data not found for today's recipeNumber.</p>";
          return;
        }

        // Build the recipe display
        let html = `
          <h3>${recipeData.recipeName}</h3>
          <p><strong>Prep Time:</strong> ${recipeData.prepTime || ""}</p>
          <h4>Ingredients:</h4>
          <ul>
            ${(recipeData.ingredientsNeeded || [])
              .map((ing) => `<li>${ing}</li>`)
              .join("")}
          </ul>
          <h4>Steps:</h4>
          <ol>
            ${(recipeData.steps || []).map((step) => `<li>${step}</li>`).join("")}
          </ol>
        `;

        recipeContainer.innerHTML = html;
      } catch (error) {
        console.error("Error loading recipe:", error);
        recipeContainer.innerHTML =
          "<p>Error loading recipe. Check console for details.</p>";
      }
    }

    /**
     * On page load, figure out which groupNumber & recipeNumber is for today by reading pull.json
     */
    async function initializeApp() {
      const today = getTodayDateCST();
      todayDateContainer.textContent = `Today: ${today}`;

      try {
        const response = await fetch("data/pull.json");
        const pullData = await response.json();

        // Attempt to find today's entry
        const foundEntry = pullData.dailySchedule.find(
          (entry) => entry.date === today
        );

        if (!foundEntry) {
          // Not found for some reason; default to group 1
          currentGroupNumber = 1;
          currentRecipeNumber = null;
          isGroceryDay = false;
          console.warn("No matching date found in pull.json; defaulting to group 1.");
        } else {
          currentGroupNumber = foundEntry.groupNumber;
          currentRecipeNumber = foundEntry.recipeNumber; // Could be null if no recipe
          isGroceryDay = foundEntry.groceryDay;
        }
      } catch (error) {
        console.error("Error reading pull.json:", error);
        // Default fallback
        currentGroupNumber = 1;
        currentRecipeNumber = null;
        isGroceryDay = false;
      }
    }

    // Click Handlers
    btnGroceryList.addEventListener("click", () => {
      showSection(grocerySection);
      loadGroceryList();
    });

    btnRecipeToday.addEventListener("click", () => {
      showSection(recipeSection);
      loadRecipe();
    });

    // Back buttons
    backButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        showSection(mainMenu);
      });
    });

    // Initialize on page load
    initializeApp();
  </script>
</body>
</html>
